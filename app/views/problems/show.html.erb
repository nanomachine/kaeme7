<% provide(:title, "Details") %>

<%= render 'layouts/sidebar' %>

<!--Bounding box heading with report id and title as well as tabbed view of photo and map -->

<div class="row-fluid fluid-box">
  <div class="box span6">
    <h1 class="h1-report">#<%=@problem.id%> - <%= @problem.title %></h1>
  </div>
  <div class="box span6">
    <div class="row-fluid fluid-box">
      <div class="box span3">
        <% if @problem.status==3 %>
          <%= link_to "#", class: 'btn btn-sucess' do %>
            <i class="icon-ok icon-white"></i> Resolved
          <% end %>
        <% elsif @problem.status==2 %>
          <%= link_to "#", class: 'btn btn-info' do %>
            <i class="icon-lock icon-white"></i> Assigned 
          <% end %>
        <% else %>
          <%= link_to "#", class: 'btn btn-warning' do %>
            <i class="fa-icon-warning-sign icon-white"></i> Unassigned
          <% end %>
        <% end %>
      </div>
      <div class="box span3">
        <% if @problem.priority==3 %>
          <%= link_to "#", class: 'btn btn-danger' do %>
            <i class="icon-warning-sign icon-white"></i> High Priority
          <% end %>
        <% elsif @problem.priority==2 %>
          <%= link_to "#", class: 'btn btn-warning' do %>
            <i class="icon-exclamation-sign icon-white"></i> Medium Priority 
          <% end %>
        <% else %>
          <%= link_to "#", class: 'btn btn-success' do %>
            <i class="icon-asterisk icon-white"></i> Low Priority
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<div class="row-fluid fluid-box">
  <div class="span12">
    <!-- Photo box     -->
    <div class="box span6">
      <div class="box-header">
        <h2><i class="fa-icon-eye-open"></i><span class="break"></span>Report Type: <%= @problem.get_prob_type %></h2>
      </div>
      <div class="box-content">
        <%= image_tag @problem.avatar.url(:medium) %>
      </div>
    </div>

    <!-- Map box      -->
    <div class="box span6">
      <div class="box-header">
        <h2><i class="fa-icon-globe"></i><span class="break"></span>Map</h2>
        <div class="box-icon">
          <% if !@problem.is_in_list? %>
            <%= link_to "#", class: "btn btn-success btn-setting-list" do %>
              <i class="icon-plus"></i> Add to list
            <% end %>
          <% else %>
            <%= link_to @problem.get_containing_list, class: "btn btn-info" do %>
              <i class="icon-list-alt"></i> Go to list
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="box-content">
        <div class="row-fluid">
          <div class="span12">
            <%= gmaps({"map_options" => {"auto_zoom" => false, "zoom" => 15 },"markers" => {"data" => @json }})%>
          </div> 
          <div class="span12">
            <div class="box span4">
              <h3>Address:</h3>
              <p>
                <%= @problem.address %>
              </p>
            </div>
            <div class="box span4">
              <h3>Latitude:</h3>
              <p><%= @problem.latitude %></p>
            </div>
            <div class="box span4">
              <h3>Longitude:</h3>
              <p><%= @problem.longitude %></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row-fluid fluid-box">
  <div class="span12">
    <!--  Description Box     -->
    <div class="box span4 ">
      <div class="box-header">
        <h2><i class="fa-icon-list"></i><span class="break"></span>Description</h2>
      </div>
      <div class="box-content">
        <p>
          <%= @problem.description %>
        </p>
      </div>
    </div>

    <!--  Details Box     -->
    <div class="box span4 ">
      <div class="box-header">
        <h2><i class="fa-icon-list"></i><span class="break"></span>Details</h2>
        <div class="box-icon">
          <%= link_to "#", class: "btn btn-setting" do %>
          <i class="icon-edit"></i> Edit 
          <% end %>
        </div>
      </div>

      <div class="box-content">
        <div class="row-fluid">
          <% if @problem.is_in_list? %>
          <% @cont_list = @problem.get_containing_list %>
          <% end %>

          <div class="box span6">
            <h3>Reporter:</h3>
            <p><%= @problem.get_owner_name%></p>
            <% if @cont_list %>
            <h3>Assigned to:</h3>
            <p><%= @cont_list.get_owner_name %></p>
            <% end %>
            <h3>Type:</h3>
            <p><%= @problem.get_prob_type %></p>
            <h3>Submitted on:</h3>
            <p><%= @problem.created_at.strftime("%b.%d %Y  @ %T") %></p>
            <% if @cont_list %>
            <h3>Assigned on:</h3>
            <p><%= @problem.assigned_at.strftime("%b.%d %Y @ %T") %></p>
            <% end %>

          </div>

          <div class="box span6">
            <h3>Priority:</h3>
            <p><%= @problem.get_prob_priority %></p>
            <% if @cont_list%>
            <h3>List:</h3>
            <p><%= @cont_list.name%>
              <% end %>
              <h3>Status:</h3>
              <p><%= @problem.get_prob_status %></p>
              <h3>Updated on:</h3>
              <p><%= @problem.updated_at.strftime(" %b.%d %Y @ %T") %></p>
            </div>

          </div>
        </div>
      </div>

      <!-- Comment box    -->
      <div class="box span4 ">
        <div class="box-header">
          <h2><i class="icon-comment"></i><span class="break"></span>Comments</h2>
        </div>
        <div class="box-content">
          <!--Preparing comments for dispaly-->
          <% @comments = @problem.comment_threads %>
          <!--This could be made a _comment partial to render-->
          <ul class="chat">
            <% @comments.each do |comment| %>
            <% @user = User.find(comment.user_id) %>

            <!-- Aling all of current user's comments to the right for organization -->
            <% if current_user!= @user %>
            <li class="left">
             <img class="avatar" alt=<%= @user.name %> src=<%= @user.avatar.url(:medium) %>>
             <span class="message">
               <span class="arrow"></span>
               <span class="from"><%= @user.name + " " + @user.last_name %></span>
               <span class="time"><%= comment.created_at.strftime(" %b.%d %Y at %T") %> </span>
               <span class="text">
                 <%= comment.body %>
               </span>
             </span>  
           </li>
           <% else %>
           <li class="right">
             <img class="avatar" src=<%= current_user.avatar.url(:medium) %>>
             <span class="message">
               <span class="arrow"></span>
               <span class="from"><%= current_user.name + " " + current_user.last_name %></span>
               <span class="time"><%= comment.created_at.strftime(" %b.%d %Y at %T") %> </span>
               <span class="text">
                 <%= comment.body %>
               </span>
             </span>  
           </li>
           <% end %>
           <% end %>
         </ul>   
       </ul> 
       <div class="chat-form">
         <%= form_tag "/problems/add_new_comment" do %>
         <%= hidden_field_tag "id", @problem.id %>
         <%= text_area :comment, :body, :size => "10x10" %>
         <%= submit_tag "Post Comment" %>
         <% end %>
       </div> 
     </div>    
   </div>
 </div>
</div>
<!-- Modal window to edit report details...............................................................-->

<%= form_for @problem, :html => {:class => "form-horizontal"} do |f| %>

<div class="modal hide fade" id="myModal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"></button>
    <h3>Edit Report</h3>
  </div>

  <div class="modal-body">
    <div class="control-group">
      <label class="control-label" for="focusedInput">Type</label>
      <div class="controls">
        <div class="input-xlarge focused" id="focusedInput" type="text">
          <%= f.select :ptype, [["Pothole", 1], ["Water pipe", 2], ["Electric cable", 3], 
          ["Light post", 4], ["Debris on road", 5], ["Vandalism", 6], ["Manhole cover", 7], ["Other", 8]] %>        
        </div>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label" for="focusedInput">Priority</label>
      <div class="controls">
        <div class="input-xlarge focused" id="focusedInput" type="text">
          <%= f.select :priority, [["Low", 1], ["Medium", 2], ["High", 3]] %>
        </div>
      </div>
    </div>
  </div>
  <div class="modal-footer"> 
    <a class="form-action btn" data-dismiss="modal">Close</a>
    <a class="form-action"> <%= f.submit "Update", class: "btn btn-success" %> </a>
  </div>
</div>
<% end %>



<div class="modal hide fade" id="myModalList">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal"></button>
    <h3>Choose a list</h3>
  </div>
  <div class="modal-body">
    <table class="table table-condensed datatable">
      <thead>
        <tr>
          <th>List #</th>
          <th>Name</th>
          <th>Date Created</th>
          <th>Actions</th>
        </tr>
      </thead>     
      <tbody>
        <% current_user.lists.each do |list| %>
        <% @owner = User.find(list.user_id) %>
        <tr>
          <td><%= list.id %></td>
          <td><%= list.name %></td>
          <td><%= list.created_at.strftime(" %b.%d %Y %T") %></td>
          <!--Action buttons for last column of list index table, Delete and More Info -->
          <td class="center">
            <%= link_to add_problem_list_path(list: list, id: list.id, problem_id: @problem.id), class: 'btn btn-mini btn-success', method: :put do %>
            <i>Add to list</i> 
            <% end %>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table> 
  </div>
</div>


